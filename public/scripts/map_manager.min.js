(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};window.MapManager=function(){function e(e){this.ref=e,this.settingMapOptions=t(this.settingMapOptions,this),this.cleanMap=t(this.cleanMap,this),this.showDirection=t(this.showDirection,this),this.openMarker=t(this.openMarker,this),this.hideAllMarkers=t(this.hideAllMarkers,this),this.showAllMarkers=t(this.showAllMarkers,this),this.popItem=t(this.popItem,this),this.checkActiveBrands=t(this.checkActiveBrands,this),this.checkBrands=t(this.checkBrands,this),this.onResize=t(this.onResize,this),this.geolocationError=t(this.geolocationError,this),this.geolocationSuccess=t(this.geolocationSuccess,this),this.findPosition=t(this.findPosition,this),this.setAddress=t(this.setAddress,this),this.findContent=t(this.findContent,this),this.setInfoWindowInteractions=t(this.setInfoWindowInteractions,this),this.setInfoWindow=t(this.setInfoWindow,this),this.setMarkers=t(this.setMarkers,this),this.onDataLoaded=t(this.onDataLoaded,this),this.loadData=t(this.loadData,this),this.initialize=t(this.initialize,this),this.setMapIntro=t(this.setMapIntro,this),this.map_container=this.ref.get(0),this.def_long=-84.575195,this.def_lat=44.139497,this.icon="/public/images/marker.png",this.iconA="/public/images/marker_a.png",this.iconB="/public/images/marker_b.png",this.data_url="/public/json/map.json",this.markers=[],this.active_brands=[],window.desktop_size||this.ref.data("baloon",280),this.infobox_width=this.ref.data("baloon"),this.offset=4,this.infoBox_pos_X=-(this.infobox_width/2)+this.offset,this.infoBox_pos_Y=-24,this.rendererOptions={suppressMarkers:!0},this.directionsService=new google.maps.DirectionsService,this.directionsDisplay=new google.maps.DirectionsRenderer(this.rendererOptions),this.directionsDisplay.setPanel(document.getElementById("directions-panel")),this.boxText="",$("body").append(this.boxText),this.infobox_options={content:this.boxText,disableAutoPan:!1,maxWidth:0,pixelOffset:new google.maps.Size(this.infoBox_pos_X,this.infoBox_pos_Y),zIndex:null,boxStyle:{background:"",opacity:1,width:"auto"},closeBoxMargin:"0",closeBoxURL:"",infoBoxClearance:new google.maps.Size(1,1),isHidden:!1,pane:"floatPane",enableEventPropagation:!1,alignBottom:!0},this.geolocation_options={enableHighAccuracy:!0,timeout:1e3,maximumAge:0},event_emitter.addListener("IS_READY",this.findPosition),event_emitter.addListener("BRAND_CHANGE",this.checkActiveBrands),event_emitter.addListener("SHOW_ALL_MARKERS",this.showAllMarkers),event_emitter.addListener("STORE_ITEM_SELECTED",this.openMarker),event_emitter.addListener("TAKE_DIRECTION",this.showDirection),event_emitter.addListener("MAP_INIT",this.initialize),event_emitter.addListener("CLEAR_DIRECTION",this.cleanMap),event_emitter.addListener("SETTING_MAP_OPTIONS",this.settingMapOptions),this.setMapIntro()}return e.prototype.setMapIntro=function(){return this.has_control=window.desktop_size?!0:!1,this.map_options={zoom:10,center:new google.maps.LatLng(this.def_lat,this.def_long),mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!1,panControl:this.has_control,panControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT},zoomControl:this.has_control,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.TOP_RIGHT},scaleControl:this.has_control,scaleControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT},streetViewControl:this.has_control,streetViewControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT}},this.map=new google.maps.Map(this.map_container,this.map_options),this.directionsDisplay.setMap(this.map)},e.prototype.initialize=function(t,e){var i,s=this;return null==t&&(t=this.def_lat),null==e&&(e=this.def_long),i=new google.maps.LatLng(t,e),this.map.setCenter(i),this.loadData(),window.is_mobile&&(this.GeoMarker=new GeolocationMarker(this.map)),google.maps.event.addListener(this.directionsDisplay,"directions_changed",function(){return event_emitter.emitEvent("DIRECTION_CHANGE_CALLBACK"),s.timeout=setTimeout(function(){return"undefined"!=typeof direction_list_iscroll&&null!==direction_list_iscroll&&(direction_list_iscroll.refresh(),direction_list_iscroll.scrollTo(0,0,0)),clearTimeout(s.timeout)},1)})},e.prototype.loadData=function(){return $.getJSON(this.data_url,this.onDataLoaded)},e.prototype.onDataLoaded=function(t){var e,i,s,o;for(e=s=0,o=t.markers.marker.length;o>=0?o>s:s>o;e=o>=0?++s:--s)i={},$.each(t.markers.marker[e],function(t,e){return i[t]=e}),this.markers.push(i);return this.setMarkers(),event_emitter.emitEvent("DATA_READY",[this.markers])},e.prototype.setMarkers=function(){var t,e,i,s,o;for(e=s=0,o=this.markers.length;o>=0?o>s:s>o;e=o>=0?++s:--s)t=this.markers[e].brands,i=new google.maps.Marker({position:new google.maps.LatLng(this.markers[e].latitude,this.markers[e].longitude),map:this.map,icon:new google.maps.MarkerImage(this.icon,null,null,null,new google.maps.Size(25,36)),animation:google.maps.Animation.DROP}),this.markers[e].marker_point=i,this.markers[e].visible=!0,google.maps.event.addListener(i,"visible_changed",function(){});return this.setInfoWindow()},e.prototype.setInfoWindow=function(){var t,e,i,s,o,n,r,a=this;for(t=this.findContent,s=this.setAddress,o=this.setInfoWindowInteractions,this.ib=new InfoBox(this.infobox_options),google.maps.event.addListener(this.ib,"domready",this.setInfoWindowInteractions),i=this.ib,e=n=0,r=this.markers.length;r>=0?r>n:n>r;e=r>=0?++n:--n)google.maps.event.addListener(this.markers[e].marker_point,"click",function(){return i.setContent(t(this)),i.open(this.map,this),event_emitter.emitEvent("DESTINATION_IS_CHANGED",[s(this)])});return window.desktop_size?void 0:google.maps.event.addListener(this.map,"click",function(){return a.ib.close()})},e.prototype.setInfoWindowInteractions=function(){var t,e,i,s=this;return i=$(".infowindow"),t=i.find(".close"),e=i.find(".direction"),t.click(function(t){return t.preventDefault(),s.ib.close()}),e.click(function(t){return t.preventDefault(),window.desktop_size?event_emitter.emitEvent("OPEN_DIRECTION"):console.log("should open the link")})},e.prototype.findContent=function(t){var e,i,s;for(e=i=0,s=this.markers.length;s>=0?s>i:i>s;e=s>=0?++i:--i)if(this.markers[e].marker_point===t)return"<div class='infowindow'>				  <div class='content'>            <a href='#' class='close' data-icon='c'></a>				    <div class='store-summary'>				      <div class='wrap-top-info'>                <div class='top-info'>                  <div class='ico-new' data-icon='z'></div>                  <h2 class='storeName'><span class='label'>"+this.markers[e].title+"</span></h2>                  <p class='storeAddress'>"+this.markers[e].address+", "+this.markers[e].cap+","+this.markers[e].city+","+this.markers[e].country+"</p>                  <span class='storeDistance'>0.km</span>                </div>              </div>				      <div class='bottom-info'>				        <div class='col-left'>				          <p class='storeOpeningHours'><span class='title'>Today Opening Hours: </span> <span class='hours'>"+this.markers[e].opening_hours+"</span></p>				          <p class='storePhone'><span class='label'>"+this.markers[e].tel+"</span></p>				        </div>				        <div class='col-right'>				          <ul class='action'>                    <li><a href='/storeinfo' class='icon info' data-icon='d'></a></li>				            <li><a href='#' class='icon direction' data-icon='a'></a></li>				          </ul>				        </div>				      </div>				    </div>				  </div>				  <div class='footer'></div>				</div>"},e.prototype.setAddress=function(t){var e,i,s;for(e=i=0,s=this.markers.length;s>=0?s>i:i>s;e=s>=0?++i:--i)if(this.markers[e].marker_point===t)return""+this.markers[e].address+", "+this.markers[e].cap+","+this.markers[e].city+","+this.markers[e].country},e.prototype.findPosition=function(){return navigator.geolocation?navigator.geolocation.getCurrentPosition(this.geolocationSuccess,this.geolocationError,this.geolocation_options):event_emitter.emitEvent("GEO_LOCATION_FAILED")},e.prototype.geolocationSuccess=function(t){return this.initialize(t.coords.latitude,t.coords.longitude)},e.prototype.geolocationError=function(){return event_emitter.emitEvent("GEO_LOCATION_FAILED")},e.prototype.onResize=function(t,e){var i,s;return s=e-parseInt($("#header").css("height")),t<window.phone_break_point&&(s-=44),this.ref.css("width",""+t+"px"),this.ref.css("height",""+s+"px"),this.map?(i=this.map.getCenter(),google.maps.event.trigger(this.map,"resize"),this.map.setCenter(i)):void 0},e.prototype.checkBrands=function(){var t,e,i,s,o,n,r,a,h;for(h=[],e=s=0,r=this.markers.length;r>=0?r>s:s>r;e=r>=0?++s:--s)if(0!==this.active_brands.length){for(o=!1,i=n=0,a=this.markers[e].brands.brand.length;a>=0?a>n:n>a;i=a>=0?++n:--n){if(t=this.markers[e].brands.brand[i],-1!==$.inArray(t,this.active_brands)){o=!0;break}o=!1}this.markers[e].visible!==o&&this.markers[e].marker_point.setVisible(o),this.markers[e].visible=o,h.push(event_emitter.emitEvent("REFRESH_STORES",[e,o]))}else this.markers[e].visible!==!0?(this.markers[e].marker_point.setVisible(!0),this.markers[e].visible=!0,h.push(event_emitter.emitEvent("REFRESH_STORES",[e,!0]))):h.push(void 0);return h},e.prototype.checkActiveBrands=function(t,e){return e?this.active_brands.push(t):this.popItem(t,this.active_brands),event_emitter.emitEvent("CHECK_ALL_OPTION",[this.active_brands.length]),this.checkBrands()},e.prototype.popItem=function(t,e){return e.splice($.inArray(t,e),1)},e.prototype.showAllMarkers=function(){return this.active_brands=[],this.checkBrands()},e.prototype.hideAllMarkers=function(){var t,e,i,s;for(s=[],t=e=0,i=this.markers.length;i>=0?i>e:e>i;t=i>=0?++e:--e)this.markers[t].marker_point.setVisible(!1),s.push(this.markers[t].visible=!1);return s},e.prototype.openMarker=function(t){return google.maps.event.trigger(this.markers[t].marker_point,"click")},e.prototype.showDirection=function(t,e,i){var s,o=this;return s={origin:t,destination:e,travelMode:i},this.directionsService.route(s,function(t,e){return e===google.maps.DirectionsStatus.ZERO_RESULTS&i===google.maps.DirectionsTravelMode.BICYCLING&&event_emitter.emitEvent("BICYCLE_MODE_ISNT_AVAILABLE"),e===google.maps.DirectionsStatus.OK?(o.directionsDisplay.setDirections(t),o.route=t.routes[0].legs[0],o.startpoint=o.route.steps[0].start_point,o.endpoint=o.route.steps[o.route.steps.length-1].end_point,o.startMarker=new google.maps.Marker({position:o.startpoint,map:o.map,icon:o.iconA}),o.stopMarker=new google.maps.Marker({position:o.endpoint,map:o.map,icon:o.iconB}),o.hideAllMarkers(),o.ib.close()):void 0})},e.prototype.cleanMap=function(){return this.directionsDisplay.setDirections({routes:[]}),console.log(this.startMarker),null!=this.startMarker&&this.startMarker.setMap(null),null!=this.stopMarker&&this.stopMarker.setMap(null),this.showAllMarkers(),this.map.setZoom(this.zoom),this.map.setCenter(this.pos)},e.prototype.settingMapOptions=function(){return this.zoom=this.map.getZoom(),this.pos=this.map.getCenter()},e}()}).call(this);